############################################################ 
# p.169, 9.1 데이터분석의 흐름 
#----------------------------------------------------------- 
#    <데이터 통계분석의 기본적인 작업 흐름> 
#----------------------------------------------------------- 
#  1) 데이터를 R로 읽어 들인다. 
#  2) 읽어 들인 데이터를 플롯한다. 
#  3) 읽어 들인 데이터의 통계량을 구한다. 
############################################################ 

############################################################ 
# p.170, 9.2 데이터를 R로 읽어 들인다. 
#----------------------------------------------------------- 
#    <표 9-1>의 예제 데이터 : 실험 그룹별 체중변화 측정 
#----------------------------------------------------------- 

flour <- c( 3, -2, -1,  0,  1, -2)  # 밀가루 사용  
diet  <- c(-4,  1, -3, -5, -2, -8)  # 다이어트약 사용  
total <- c(flour, diet)             # 12명의 데이터를 total 변수로 읽어들임.  
  

############################################################ 
# p.170, 9.3 데이터를 플롯한다. 
#----------------------------------------------------------- 
#   1) 데이터에 대한 요점 파악이 목적. => hist() 
#----------------------------------------------------------- 

hist(total) 

#----------------------------------------------------------- 
#   2) 두 그룹 간 비교 => plot(density(벡터)) 
#----------------------------------------------------------- 

plot(density(flour), xlim=c(-8,8), ylim=c(0,0.2), lty=1, ann=F) 

par(new=T) 

plot(density(diet),  xlim=c(-8,8), ylim=c(0,0.2), lty=2) 

legend(4, 0.2, c("flour","diet"), lty=1:2, ncol=1)   # 범례를 그린다  

#----------------------------------------------------------- 
#   3) 두 그룹 간 비교 => boxplot() 
#----------------------------------------------------------- 

boxplot(flour, diet, names=c("flour", "diet")) 

############################################################ 
# p.173, 9장 연습문제(1) 
#----------------------------------------------------------- 
#   1. 12명 전원의 데이터 'total'에 대해 상자수염그림을 그리기 
#----------------------------------------------------------- 

boxplot(total)                         # 상자를 세로로 한다  
boxplot(total, horizontal=T)           # 상자를 가로로 한다  


############################################################ 
# p.173, 9.4 데이터의 통계량을 구한다. 
#----------------------------------------------------------- 
#  * 기본 통계량을 구한다. 
############################################################ 
#                        [퉁계함수 목록] 
#----------------------------------------------------------- 
#      sum(x)        총합 
#----------------------------------------------------------- 
#    mean(x)        평균 
#----------------------------------------------------------- 
#    median(x)        중앙값 
#----------------------------------------------------------- 
#    var(x)        불편분산 
#----------------------------------------------------------- 
#    sd(x)            표준편차 
#----------------------------------------------------------- 
#    max(x)        최대값 
#----------------------------------------------------------- 
#    min(x)        최소값 
#----------------------------------------------------------- 
#    weighted.mean(x)    가중평균 
#----------------------------------------------------------- 
#    var(x,y)        불편 공분산 
#----------------------------------------------------------- 
#    cor(x,y)        상관게수 
#----------------------------------------------------------- 
#    IQR(x)        사분위 편차 
#----------------------------------------------------------- 
#    fivenum(x)        다섯 수치 요약 
#----------------------------------------------------------- 
#    quantile(x)        분위수점(퀀타일점) 
#----------------------------------------------------------- 
#    range(x)        범위 
#----------------------------------------------------------- 
#    ave(x)        평균(인자) 
############################################################ 
  
#----------------------------------------------------------- 
# 1) 12명 전원의 체중 변화에 대한 통계량 산출 : <집중의 정도> 
#----------------------------------------------------------- 
  
sum(total) 
quantile(total, prob=0.8, name=F) # 아래에서 확률 0.8인 위치의 데이터  
fivenum(total)                    # min, 1Q, median, 3Q, max 
sum( (total-mean(total))^2 )      # 평항합  
  
#----------------------------------------------------------- 
# 2) 12명 전원의 체중 변화에 대한 통계량 산출 : <퍼짐의 정도> 
#----------------------------------------------------------- 
# var(x)는 일반적인 분산이 아님.  
# => variance(x) = var(x) * (length(x) - 1) / length(x) 
#----------------------------------------------------------- 
  
variance <- function(x) var(x)*(length(x)-1)/length(x) 
  
variance(total)                   # 표본분산  
var(total)                        # 불편분산  
sd(total)                         # 표준편차 = sqrt(var(total)) 
  
#----------------------------------------------------------- 
# 3) 그룹 간의 관련성 :  
#----------------------------------------------------------- 
#  var(x,y)도 불편 공분산, 불편공분산 행렬을 구하는 함수 
#  covariance(x,y) = var(x,y) * (length(x)-1)/length(x) 
#----------------------------------------------------------- 
  
var(flour, diet)                  # 불편공분산행렬  
cor(flour, diet)                  # 상관계수  
  
  
############################################################ 
# p.175 9.5 검정 결과 보기 
#----------------------------------------------------------- 
# t 검정을 시행하는 t.test(). 검정 사례와 검정 결과 출력 
############################################################ 
  
############################################################ 
# p.175 9.5.1 검정함수의 기본 
############################################################ 
#      함수명(데이터를 벡터나 행렬로 지정) 
#----------------------------------------------------------- 
# 함수명(x) : 하나의 표본에 대한 검정 => 하나의 벡터 x 
#----------------------------------------------------------- 
# 함수명(x,y) : 두 개의 표본에 대한 검정 => 두 개의 벡터 x, y 
#----------------------------------------------------------- 
# 함수명(A) : 2*2 분할표나 분산분석표 등에 대한 검정 => 행렬 A 
############################################################ 
  
############################################################ 
# p.176 9.5.2 검정 사례(1) : 1표본 t 검정 
#----------------------------------------------------------- 
# t.test(x, y=NULL, alternative=c("two sided", "less", "greater"), 
#        mu=0, paired=FALSE, var.euqal=FALSE, conf.level=0.95) 
############################################################ 
  
#----------------------------------------------------------- 
# 1) 하나의 표본에 대한 검정 (양측 검정) 
#----------------------------------------------------------- 
#    => 다이어트 약을 복용한 그룹의 체중 모평균 mu=0 인지 양측 검정 
#----------------------------------------------------------- 
  
t.test(diet, mu=0)                     # 양측검정 
  
#*********************************************************** 
#            ====== 출력 결과에 대한 설명 ======  [매우 중요] 
#----------------------------------------------------------- 
# 1) data : 검정한 데이터의 이름 
# 2) t = -2.842 : t의 값, 이 값이 기각역에 들어가는지 본다. 
# 3) df = 5 : t의 자유도 
# 4) p-value = 0.03616 : (p의 값)  
#    ==> 이 값이 (양측 검증)0.05 보다 작으면 '유의하다' (귀무가설을 기각) 
# 5) alternative hypothesis : 대립가설. 모평균이 0이 아님. 
# 6) 95 percent confidence interval : 95% 수준의 신뢰구간  
# 7) sample estimates: 추정값. 지금은 표본평균을 추정하고 있으며, -3.5임 
#*********************************************************** 
  
#----------------------------------------------------------- 
# 2) 하나의 표본에 대한 검정 (단측 검정) 
#    => 다이어트 약을 복용한 그룹의 체중 모평균 mu>0 인지 양측 검정 
#----------------------------------------------------------- 
  
t.test(diet, mu=0, alternative="greater") 
  
############################################################ 
# p.178 9.5.3 검정 사례(2) : 2표본 t 검정 
#----------------------------------------------------------- 
# 두 그룹(flour, diet)의 평균이 같은지 아닌지 검증. 
#----------------------------------------------------------- 
  
t.test(flour, diet, var.equal=T) 
  
#*********************************************************** 
#            ====== 출력 결과에 대한 설명 ======  [매우 중요] 
#----------------------------------------------------------- 
# 1) data : 검정한 데이터의 이름 
# 2) t = 2.2763 
# 3) df = 10 : t의 자유도 
# 4) p-value = 0.04608 : (p의 값)  
#    ==> 이 값이 (양측 검증)0.05 보다 작다. => '유의하다' (귀무가설을 기각) 
# 5) alternative hypothesis : 대립가설. 두 그룹의 평균차가 0이 아님. 
# 6) 95 percent confidence interval : 95% 수준의 신뢰구간  
# 7) sample estimates: 추정값. 지금은 표본평균을 추정하고 있으며, 
#           x그룹은 -0.16666667, y 그룹은 -3.500000임 
#*********************************************************** 
  
  
############################################################ 
# p.179 9.5.4 함수 t.text()의 인수 
#----------------------------------------------------------- 
#                [<표 9-3> 함수 t.text()의 인수] 
#----------------------------------------------------------- 
#     x            데이터 값의 수치 벡터 
#----------------------------------------------------------- 
#     y            추가 데이터 값. 1표본 검정시 생략,  
#                2표본 검정시 사용 
#----------------------------------------------------------- 
#     alternative        대립가설을 나타내는 문자열(중요).  
#                생략시 양측검정 
#                "two.sided" : 양측검정(기본값) 
#                "greater" : 더 큰지 검정(단측검정) 
#                "less" : 더 작은지 검정(단측검정) 
#----------------------------------------------------------- 
#     mu            평균값. 2표본 검정인 경우 평균의 차이를 입력. 
#----------------------------------------------------------- 
#     paired        논리값.  
#                TRUE를 입력하면 대응표본 t검정을 한다. 
#----------------------------------------------------------- 
#     var.equal        논리값.  
#                TRUE를 입력하면, 두 표본의 분산이 같다고 가정함. 
#----------------------------------------------------------- 
#     conf.level        구간의 신뢰도 
############################################################ 
  
############################################################ 
# <주의사항> 
#----------------------------------------------------------- 
# 1) paired가 TRUE이면, x와 y는 같은 길이의 벡터를 주어야만 한다. 
# 2) 결손값은 제거된다. paired가 TRUE일 때에는 쌍으로 제거된다. 
# 3) var.equal이 TRUE이면, 두 표본을 풀링했을 때의 분산값이 추정값으로 사용되고, 
#    FALSE이면, 분산은 각각 표본별로 추정된다. FALSE일 때의 추정에는 웰치의  
#    근사자유도가 사용된다. 
############################################################ 
  
  
############################################################ 
# p.179 9.5.5 반환값 
#----------------------------------------------------------- 
#   result <- t.test() 
#   result?label 
#----------------------------------------------------------- 
#                 <표 9-3> 반환값의 라벨 
#----------------------------------------------------------- 
#    statistic        t 통계량의 값     
#----------------------------------------------------------- 
#    parameters        t 통계량의 자유도 
#----------------------------------------------------------- 
#    p.value        검정한 p-값(중요).  
#            .p-값 < 0.05 : 유의하다.(귀무가설 기각) 
#            .p-값 >= 0.05 : 유의하지 않다.(귀무가설 채택) 
#----------------------------------------------------------- 
#    conf.int        평균 **% 신뢰구간 
#----------------------------------------------------------- 
#    estimate        1표본일 때는 추정된 평균의 값,  
#                2표본일 때는 추정된 평균의 차 
#----------------------------------------------------------- 
#    null.value        1표본일 때는 가정된 평균의 값,  
#                2표본일 때는 가정된 평균의 차 
#----------------------------------------------------------- 
#    alternative        대립가설을 나타내는 문자열 
#----------------------------------------------------------- 
#    method        t 검정의 종류를 나타내는 문자열 
#----------------------------------------------------------- 
#    data.name    데이터의 이름을 나타내는 문자열 
############################################################ 
  
############################################################ 
# p.180, 9.6 직선회귀, 최소제곱법 
#----------------------------------------------------------- 
#  신장과 체중의 관계 
############################################################ 
  
############################################################ 
# p.180 9.6.1 직선회귀, 최소제곱법의 기본 
############################################################ 
#                   [ 함수명(모델식) ] 
#----------------------------------------------------------- 
# 1) 함수명(y~x) : 모델식 y= a + bx + e(e:오차항) 
#              y: 목적변수의 벡터, x: 설명변수의 벡터 
#----------------------------------------------------------- 
# 2) 함수명(y~x1+x2) : 모델식 y= a + b1x1 + b2x2 + e(e:오차항) 
#              y: 목적변수의 벡터, x1,x2: 설명변수의 벡터 
#----------------------------------------------------------- 
# 3) 함수명(y~x1*x2) : 모델식 y= a + b1x1 + b2x2 + b3x1x2 + e(e:오차항) 
#              y: 목적변수의 벡터, x1,x2: 설명변수의 벡터 
#----------------------------------------------------------- 
# 4) 함수명(y~..data=데이터명) :  
#      어떤 데이터에 목적변수 y와 설명변수 x1, x2, ... 
#      모델식 y= a + b1x1 + b2x2 + b3x3 + ... + e(e:오차항) 일 떄 
#      y: 목적변수의 벡터지정, 우변은 'y 이외'라는 의미로 '.' 지정할 수 있다. 
############################################################ 
  
#----------------------------------------------------------- 
# 직선회귀, 최소제곱볍을 실행하는 함수 : lm() 
# ==> 위 방법으로 데이터를 지정한다. 
#----------------------------------------------------------- 
  
############################################################ 
# p.181 9.6.2 데이터 입력과 플롯 
############################################################ 
#  y = a + bx + e     의 a,b 추정 
# 
#   목적변수 y의 벡터 데이터, 설명변수 x의 벡터 데이터를 가지고, 
#   오차(e)를 최소로하는 a와 b를 추정한다.              
#----------------------------------------------------------- 
  
#----------------------------------------------------------- 
# <표 9-5>와 같은 신장과 체중 데이터 
#----------------------------------------------------------- 
  
#----------------------------------------------------------- 
# 1) 신장과 체중 데이터 입력 
#----------------------------------------------------------- 
  
height <- c(177,165,175,168,171,168,190,167,173,172,171,177) 
weight <- c( 62, 65, 75, 58, 59, 66, 74, 61, 70, 80, 71, 68) 
  
#----------------------------------------------------------- 
# 2) 신장과 체중 데이터 플롯 
#----------------------------------------------------------- 
  
plot(weight, height) 
  
#----------------------------------------------------------- 
# 3) 신장과 체중의 회귀분석 및 플롯 
#    => 3-1) lm()으로 회귀분석 
#       3-2) 회귀분석 결과를 result 변수에 대입 
#       3-3) abline(result)로 플롯 
#----------------------------------------------------------- 
  
result <- lm(height ~ weight)     # 단회귀분석  
abline(result) 
result <- lm(height ~ weight)     # 단회귀분석  
  
  
############################################################ 
# p.183 9.6.3 직선회귀, 최소제곱법 
#----------------------------------------------------------- 
#   -. 직선회귀, 최소제곱법은 함수 lm() 사용 
#   -. 분석 결과의 요약은 함수 summary() 사용 
############################################################ 
  
#----------------------------------------------------------- 
# 1) 분석결과의 요약 
#----------------------------------------------------------- 
  
summary(result)                   # 분석결과 요약  
  
#****************************** 
# 요약결과 설명 : 교재 p.184 참고 
#****************************** 
  
#----------------------------------------------------------- 
# 2) 추정값과 예측값의 신뢰구간 
#----------------------------------------------------------- 
#  predict()의 인수 interval="confidence" ==> '추정값'과 '그 신뢰구간' 
#  predict()의 인수 interval="predict" ==> '추정값'과 '예측값의 신뢰구간' 
#----------------------------------------------------------- 
  
new <- data.frame(weight = 68) 
predict(result, new, interval="confidence", level=0.95) 
predict(result, new, interval="predict", level=0.95) 
  
#----------------------------------------------------------- 
# 3) 예측구간 result.pre와 신뢰구간 result.con의 생성과 플롯 
#----------------------------------------------------------- 
  
new <- data.frame(weight = seq(55, 80, 1)) 
result.pre <- predict(result, new, interval="prediction") 
result.con <- predict(result, new, interval="confidence") 
matplot(new$weight, cbind(result.pre, result.con), type="l") 
  
############################################################ 
# p.186, 9장 연습문제(3) 
#----------------------------------------------------------- 
#  1. 밀가루 복용 그룹의 flour에 대해 모평균이 0인지, 1표본 t 검정 시행 
#----------------------------------------------------------- 
  
t.test(flour, mu=0) 
  
#----------------------------------------------------------- 
#  2. 한 주간의 근무시간과 그날의 음중량에 대한 회귀분석 및 플롯 
#----------------------------------------------------------- 
  
work <- c(8.0, 8.5, 10.0, 7.5, 9.0, 8.0,  9.5) 
beer <- c(500, 750, 1250, 350, 850, 850, 1000) 
result <- lm(beer ~ work) 
summary(result) 
plot(work, beer) 
abline(result) 
  
############################################################ 
# p.186, 9.7 보충학습 
#----------------------------------------------------------- 
#  9.7.1 분산이 같은 지, 다른 지 검정하기 
#----------------------------------------------------------- 
#  두 그룹의 분산에 대한 검정. 
#  귀무가설 : 두 그룹의 분산이 같다. 
#----------------------------------------------------------- 
  
var.test(flour, diet) 
  
#----------------------------------------------------------- 
# (결과 해석) p-값 > 0.05 => 귀무가설을 기각할 수 없다. 
#----------------------------------------------------------- 
  
#----------------------------------------------------------- 
#  9.7.2 편상관행렬 
#----------------------------------------------------------- 
  
#---------- 함수정의 
  
my.cor <- function(x) { 
  tmpcor <- cor(x) 
  if (det(tmpcor) != 0)  sol <- solve(tmpcor) 
  else { library(MASS);  sol <- ginv(tmpcor) } 
  d <- diag(sol) 
  sol <- -sol/sqrt(outer(d,d)) 
  rownames(sol) <- paste("Var", 1:ncol(x)) 
  colnames(sol) <- paste("Var", 1:ncol(x)) 
  return(sol) 
} 
  
x <- matrix(c(1:9), ncol=3, byrow=T) 
  
my.cor(x) 
  
#----------------------------------------------------------- 
#  9.7.3 데이터의 표준화 
#----------------------------------------------------------- 
#  행렬 x에 대하여 각 변량의 단위가 다를 때, 각 변량을 평균 0, 분산 1이 되도록 변환 
#----------------------------------------------------------- 
#  <표준화> 평균 = 0 (센터링), 분산 = 1 (스케일링) 
#   함수 scale()에 center=F로 센터링 억게, scale=F로 스케링 억제 
#----------------------------------------------------------- 
  
height <- c(177,165,175,168,171,168,190,167,173,172,171,177) 
scale(height) 
